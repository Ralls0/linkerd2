#!/usr/bin/env sh

# If the first argument to this script is "latest" or unset, it fetches the
# latest proxy binary from the linkerd2-proxy github releases. If it's set to
# a linkerd2-proxy version number (such as v2.76.0), it will fetch the binary
# matching that version number instead.

set -eu

bindir=$( cd "${0%/*}" && pwd )
rootdir=$( cd "$bindir"/.. && pwd )
builddir="$rootdir/target/proxy"
echo "[i] bindir: ${bindir}"
echo "[i] rootdir: ${rootdir}"
echo "[i] builddir: ${builddir}"

version=${1:-latest}
if [ "$version" = latest ]; then
  version=$(curl -sL https://api.github.com/repos/Ralls0/linkerd2-proxy/releases/latest |jq -r .tag_name | sed 's,^release/,,')
fi

echo "[i] version: ${version}"

assetbase="https://github.com/Ralls0/linkerd2-proxy/releases/download/${version}"
arch=${2:-amd64}
pkgname="linkerd2-proxy-${version}-${arch}"
pkgfile="${pkgname}.tar.gz"

echo "[i] assetbase: ${assetbase}"
echo "[i] arch: ${arch}"
echo "[i] pkgname: ${pkgname}"
echo "[i] pkgfile: ${pkgfile}"

mkdir -p "$builddir"
cd "$builddir"
echo "[i] curl: $assetbase/$pkgfile"
curl -sLO "$assetbase/$pkgfile"

echo "[i] tar: $pkgfile"
tar -zxvf "$pkgfile" >&2

mv "$pkgname/LICENSE" .
mv "$pkgname/bin/linkerd2-proxy" .
rm -r "$pkgfile" "$pkgname"
mv linkerd2-proxy "$pkgname"
echo "$builddir/$pkgname"
